name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.cuda }}, ${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - cuda: '12.2.0'
            arch: 'sm_75'
            suffix: 'turing'
          - cuda: '12.2.0'
            arch: 'sm_80'
            suffix: 'ampere'
          - cuda: '12.2.0'
            arch: 'sm_86'
            suffix: 'ga102'
          - cuda: '12.2.0'
            arch: 'sm_89'
            suffix: 'ada'

    container:
      image: nvidia/cuda:${{ matrix.cuda }}-devel-ubuntu22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build
        run: make CUDA_ARCH=${{ matrix.arch }}

      - name: Package
        run: |
          mkdir -p dist
          tar -czvf dist/popcorn-${{ github.ref_name }}-${{ matrix.suffix }}.tar.gz \
            lib/libpopcorn.a \
            include/popcorn.h \
            README.md \
            LICENSE

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: popcorn-${{ matrix.suffix }}
          path: dist/*.tar.gz

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;
          ls -la release/

      - name: Create source archive
        run: |
          tar -czvf release/popcorn-${{ github.ref_name }}-source.tar.gz \
            --exclude='.git' \
            --exclude='build' \
            --exclude='lib' \
            .

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.tar.gz
            release/SHA256SUMS.txt
          generate_release_notes: true
          body: |
            ## Installation

            Download the appropriate archive for your GPU architecture:

            | Archive | GPU Architecture |
            |---------|------------------|
            | `popcorn-${{ github.ref_name }}-turing.tar.gz` | Turing (RTX 20xx, GTX 16xx) |
            | `popcorn-${{ github.ref_name }}-ampere.tar.gz` | Ampere (RTX 30xx, A100) |
            | `popcorn-${{ github.ref_name }}-ga102.tar.gz` | GA102 (RTX 3080, 3090) |
            | `popcorn-${{ github.ref_name }}-ada.tar.gz` | Ada Lovelace (RTX 40xx) |

            Or build from source with `popcorn-${{ github.ref_name }}-source.tar.gz`.

            ## Verify

            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

  notify:
    name: Post-release
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Create post-release issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.ref_name }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${version} post-release checklist`,
              body: `## Post-release checklist for ${version}\n\n- [ ] Update tendo to use new version\n- [ ] Test integration in tendo\n- [ ] Update documentation if needed\n- [ ] Announce release if significant`,
              labels: ['release']
            });
